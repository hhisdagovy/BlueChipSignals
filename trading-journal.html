<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal - Blue Chip Signals</title>
    <link rel="icon" type="image/png" href="assets/images/logo.png">
    <link rel="stylesheet" href="assets/css/global.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        :root {
            --primary-gold: #b3a17d;
            --secondary-gold: #E2CFB5;
            --dark-bg: #080B0F;
            --darker-bg: #050810;
            --light-text: #FFFFFF;
            --gray-text: #A0A0A0;
            --card-bg: rgba(18, 22, 32, 0.72);
            --success-green: #2a571f;
            --danger-red: #ef4444;
            --border-color: rgba(201, 176, 55, 0.25);
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(1200px 800px at -10% -10%, rgba(201, 176, 55, 0.25), transparent 55%),
                        radial-gradient(900px 900px at 110% 10%, rgba(59, 130, 246, 0.15), transparent 60%),
                        linear-gradient(160deg, rgba(5, 8, 16, 0.92) 25%, rgba(8, 12, 22, 0.98) 70%);
            pointer-events: none;
            z-index: -2;
        }

        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background: repeating-linear-gradient(135deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 2px, transparent 2px, transparent 6px);
            opacity: 0.6;
            pointer-events: none;
            z-index: -1;
            mix-blend-mode: lighten;
        }

        /* ---- Journal Hero ---- */
        .journal-hero {
            margin-top: 100px;
            padding: 2rem 2rem 1.5rem;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            display: flex;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .journal-hero-left { flex: 1; min-width: 180px; }

        .journal-hero-left h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-gold), var(--secondary-gold));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.25rem;
        }

        .journal-hero-left p {
            color: var(--gray-text);
            font-size: 0.88rem;
        }

        .journal-hero-center {
            text-align: center;
            flex: 1;
            min-width: 160px;
        }

        .hero-pnl-label {
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--gray-text);
            margin-bottom: 0.2rem;
        }

        .hero-pnl-number {
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            color: var(--primary-gold);
            transition: color 0.3s;
        }

        .hero-pnl-number.positive { color: #4ade80; }
        .hero-pnl-number.negative { color: var(--danger-red); }

        .journal-hero-right { flex-shrink: 0; }

        /* ---- Container ---- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem 3rem;
        }

        /* ---- Stats Row ---- */
        .stats-row {
            display: flex;
            gap: 2.5rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(201, 176, 55, 0.1);
        }

        .stat-chip {
            display: flex;
            flex-direction: column;
            gap: 0.1rem;
        }

        .stat-chip-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--gray-text);
        }

        .stat-chip-value {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--light-text);
        }

        /* ---- Tab Bar ---- */
        .tab-bar {
            display: flex;
            gap: 0;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid rgba(201, 176, 55, 0.12);
        }

        .tab-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.65rem 1.3rem;
            font-size: 0.88rem;
            font-weight: 600;
            color: var(--gray-text);
            font-family: inherit;
            transition: color 0.2s;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .tab-btn:hover { color: var(--light-text); }

        .tab-btn.active {
            color: var(--primary-gold);
            border-bottom-color: var(--primary-gold);
        }

        /* ---- Tab Panels ---- */
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* ---- Overview Panel ---- */
        .overview-insight-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .insight-mini {
            background: rgba(10, 14, 22, 0.7);
            border: 1px solid rgba(201, 176, 55, 0.15);
            border-radius: 12px;
            padding: 1rem 1.25rem;
        }

        .insight-mini-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--gray-text);
            margin-bottom: 0.35rem;
        }

        .insight-mini-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--light-text);
        }

        .progress-track {
            height: 4px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .progress-fill {
            display: block;
            height: 100%;
            width: 0%;
            background: linear-gradient(135deg, #34d399, #0ea5e9);
            transition: width 0.5s ease;
        }

        /* ---- Charts ---- */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(460px, 1fr));
            gap: 1.5rem;
        }

        .chart-container {
            background: rgba(10, 14, 22, 0.7);
            border: 1px solid rgba(201, 176, 55, 0.18);
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.25);
            position: relative;
            overflow: hidden;
        }

        .chart-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-gold), var(--secondary-gold));
        }

        .chart-title {
            background: linear-gradient(135deg, var(--primary-gold), var(--secondary-gold));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            z-index: 1;
        }

        .chart-empty-state {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--gray-text);
            z-index: 2;
        }

        .chart-empty-state p { margin: 0; font-size: 0.9rem; }

        /* ---- Trades tab header ---- */
        .trades-tab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .filter-bar {
            display: flex;
            gap: 0.6rem;
            flex-wrap: wrap;
            flex: 1;
        }

        .filter-bar select {
            padding: 0.38rem 0.75rem;
            background: rgba(10, 14, 22, 0.8);
            border: 1px solid rgba(201, 176, 55, 0.18);
            border-radius: 8px;
            color: var(--light-text);
            font-size: 0.8rem;
            font-family: inherit;
            transition: border-color 0.2s;
            cursor: pointer;
        }

        .filter-bar select:hover,
        .filter-bar select:focus { border-color: var(--primary-gold); outline: none; }

        .trades-actions { display: flex; gap: 0.5rem; }

        /* ---- Trade Rows ---- */
        .trade-row {
            background: rgba(10, 14, 22, 0.5);
            border: 1px solid rgba(201, 176, 55, 0.1);
            border-radius: 12px;
            margin-bottom: 0.5rem;
            overflow: hidden;
            transition: border-color 0.2s;
        }

        .trade-row:hover { border-color: rgba(201, 176, 55, 0.25); }

        .trade-row-main {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            gap: 0.75rem;
            cursor: pointer;
            user-select: none;
        }

        .trade-ticker-icon {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 800;
            letter-spacing: 0.02em;
            flex-shrink: 0;
            border: 1px solid rgba(255,255,255,0.08);
        }

        .trade-ticker-icon.spy   { background: rgba(179,161,125,0.15); color: var(--primary-gold); }
        .trade-ticker-icon.tsla  { background: rgba(255,102,102,0.12); color: #ff6666; }
        .trade-ticker-icon.meta  { background: rgba(91,158,255,0.12);  color: #5b9eff; }
        .trade-ticker-icon.aapl  { background: rgba(179,179,179,0.12); color: #b3b3b3; }
        .trade-ticker-icon.nvda  { background: rgba(143,219,47,0.12);  color: #8fdb2f; }
        .trade-ticker-icon.amzn  { background: rgba(255,170,51,0.12);  color: #ffaa33; }
        .trade-ticker-icon.other { background: rgba(179,161,125,0.1);  color: var(--gray-text); }

        .trade-info { flex: 1; min-width: 0; }

        .trade-ticker-name {
            font-size: 0.92rem;
            font-weight: 700;
            color: var(--light-text);
        }

        .trade-date {
            font-size: 0.74rem;
            color: var(--gray-text);
        }

        .trade-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.55rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .trade-badge.long   { background: rgba(74,222,128,0.12);  color: #4ade80; }
        .trade-badge.short  { background: rgba(239,68,68,0.12);   color: #f87171; }
        .trade-badge.stock  { background: rgba(59,130,246,0.12);  color: #60a5fa; }
        .trade-badge.option { background: rgba(147,51,234,0.12);  color: #a78bfa; }

        .trade-pnl {
            text-align: right;
            flex-shrink: 0;
            min-width: 80px;
        }

        .trade-pnl-amount {
            font-size: 1rem;
            font-weight: 700;
        }

        .trade-pnl-amount.positive { color: #4ade80; }
        .trade-pnl-amount.negative { color: #f87171; }
        .trade-pnl-amount.neutral  { color: var(--gray-text); }

        .trade-status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.55rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .trade-status-badge.open   { background: rgba(59,130,246,0.15);  color: #60a5fa; }
        .trade-status-badge.closed { background: rgba(107,114,128,0.15); color: #9ca3af; }

        .trade-chevron {
            color: var(--gray-text);
            font-size: 0.7rem;
            transition: transform 0.25s;
            flex-shrink: 0;
        }

        .trade-row.expanded .trade-chevron { transform: rotate(180deg); }

        .trade-row-detail {
            display: none;
            padding: 0 1rem 0.9rem;
            border-top: 1px solid rgba(255,255,255,0.04);
        }

        .trade-row.expanded .trade-row-detail { display: block; }

        .trade-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 0.5rem 1.5rem;
            padding-top: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .trade-detail-label {
            font-size: 0.68rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--gray-text);
            margin-bottom: 0.1rem;
        }

        .trade-detail-value {
            font-size: 0.83rem;
            font-weight: 600;
            color: var(--light-text);
        }

        .trade-detail-notes {
            font-size: 0.81rem;
            color: var(--gray-text);
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255,255,255,0.04);
            line-height: 1.5;
        }

        .trade-detail-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        /* ---- Empty State ---- */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--gray-text);
        }

        .empty-state i {
            font-size: 3rem;
            color: rgba(201, 176, 55, 0.25);
            margin-bottom: 1rem;
            display: block;
        }

        .empty-state p {
            font-size: 1rem;
            margin-bottom: 1.5rem;
        }

        /* ---- Buttons ---- */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.65rem 1.4rem;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.25s ease;
            font-size: 0.9rem;
            font-family: inherit;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-gold), var(--secondary-gold));
            color: var(--dark-bg);
            box-shadow: 0 4px 14px rgba(201, 176, 55, 0.25);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 22px rgba(201, 176, 55, 0.4);
        }

        .btn-secondary {
            background: rgba(10, 14, 22, 0.8);
            color: var(--light-text);
            border: 1px solid rgba(201, 176, 55, 0.2);
        }

        .btn-secondary:hover {
            border-color: var(--primary-gold);
            background: rgba(201, 176, 55, 0.06);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.12);
            color: var(--danger-red);
            border: 1px solid rgba(239, 68, 68, 0.22);
        }

        .btn-danger:hover { background: rgba(239, 68, 68, 0.22); }

        .btn-sm { padding: 0.38rem 0.85rem; font-size: 0.8rem; }

        /* ---- Modal ---- */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.72);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        .modal.active { display: flex; }

        .modal-content {
            background: rgba(12, 16, 26, 0.98);
            border: 1px solid rgba(201, 176, 55, 0.22);
            padding: 2rem;
            border-radius: 20px;
            max-width: 720px;
            width: 92%;
            max-height: 88vh;
            overflow-y: auto;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.6);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.25rem;
            background: linear-gradient(135deg, var(--primary-gold), var(--secondary-gold));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--gray-text);
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.2s;
            padding: 0.25rem;
        }

        .close-modal:hover { color: var(--danger-red); }

        /* ---- Form ---- */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
            gap: 1rem;
            margin-bottom: 1.25rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .form-group.full-width { grid-column: 1 / -1; }

        .form-group label {
            color: var(--gray-text);
            font-weight: 500;
            font-size: 0.84rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.65rem 0.9rem;
            background: var(--darker-bg);
            border: 1px solid rgba(201, 176, 55, 0.2);
            border-radius: 8px;
            color: var(--light-text);
            font-size: 0.9rem;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-gold);
            box-shadow: 0 0 0 3px rgba(201, 176, 55, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* ---- Responsive ---- */
        @media (max-width: 768px) {
            .journal-hero {
                margin-top: 80px;
                flex-direction: column;
                text-align: center;
                padding: 1.5rem 1rem 1rem;
                gap: 1rem;
            }

            .container { padding: 0 1rem 2rem; }

            .stats-row { gap: 1.25rem 2rem; }

            .overview-insight-row { grid-template-columns: 1fr; }

            .charts-grid { grid-template-columns: 1fr; }

            .trades-tab-header { flex-direction: column; align-items: flex-start; }

            .trade-badge.stock,
            .trade-badge.option { display: none; }

            .trade-row-main { gap: 0.5rem; padding: 0.65rem 0.75rem; }

            .modal-content { padding: 1.5rem 1rem; }

            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <div id="nav-placeholder" data-nav-type="public"></div>
    <script src="assets/js/nav-component.js"></script>

    <!-- Journal Hero -->
    <div class="journal-hero">
        <div class="journal-hero-left">
            <h1><i class="fas fa-book-open" style="font-size:1.1rem;margin-right:0.4rem;"></i>Trading Journal</h1>
            <p>Track, analyze, and improve your trading performance</p>
        </div>
        <div class="journal-hero-center">
            <div class="hero-pnl-label">Total P&amp;L</div>
            <div class="hero-pnl-number" id="heroPnL">+$0.00</div>
        </div>
        <div class="journal-hero-right">
            <button class="btn btn-primary" onclick="openTradeModal()">
                <i class="fas fa-plus"></i> Add Trade
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">

        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-chip">
                <span class="stat-chip-label">Total Trades</span>
                <span class="stat-chip-value" id="totalTrades">0</span>
            </div>
            <div class="stat-chip">
                <span class="stat-chip-label">Win Rate</span>
                <span class="stat-chip-value" id="winRate">0%</span>
            </div>
            <div class="stat-chip">
                <span class="stat-chip-label">Best Trade</span>
                <span class="stat-chip-value" id="bestTrade">$0.00</span>
            </div>
            <div class="stat-chip">
                <span class="stat-chip-label">Open Positions</span>
                <span class="stat-chip-value" id="openPositions">0</span>
            </div>
        </div>

        <!-- Tab Bar -->
        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('overview', this)">Overview</button>
            <button class="tab-btn" onclick="switchTab('trades', this)">Trades</button>
            <button class="tab-btn" onclick="switchTab('analytics', this)">Analytics</button>
        </div>

        <!-- Overview Tab -->
        <div class="tab-panel active" id="tab-overview">
            <div class="chart-container" style="margin-bottom:1.5rem;">
                <h3 class="chart-title"><i class="fas fa-chart-line"></i> Equity Curve</h3>
                <div style="position:relative;height:260px;">
                    <canvas id="equityCurveChart"></canvas>
                    <div id="equityCurveEmpty" class="chart-empty-state" style="display:none;">
                        <i class="fas fa-chart-line" style="font-size:2.5rem;color:rgba(201,176,55,0.25);margin-bottom:0.75rem;"></i>
                        <p>Add closed trades to see your equity curve</p>
                    </div>
                </div>
            </div>
            <div class="overview-insight-row">
                <div class="insight-mini">
                    <div class="insight-mini-label">Net Performance</div>
                    <div class="insight-mini-value" id="insightTotalPnL">+$0.00</div>
                </div>
                <div class="insight-mini">
                    <div class="insight-mini-label">Win Rate</div>
                    <div class="insight-mini-value" id="insightWinRate">0%</div>
                    <div class="progress-track"><span class="progress-fill" id="winRateProgress"></span></div>
                </div>
                <div class="insight-mini">
                    <div class="insight-mini-label">Open Positions</div>
                    <div class="insight-mini-value" id="openTradesInsight">0</div>
                </div>
            </div>
        </div>

        <!-- Trades Tab -->
        <div class="tab-panel" id="tab-trades">
            <div class="trades-tab-header">
                <div class="filter-bar">
                    <select id="filterTradeType" onchange="filterTrades()">
                        <option value="">All Types</option>
                        <option value="Stock">Stocks</option>
                        <option value="Option">Options</option>
                    </select>
                    <select id="filterTicker" onchange="filterTrades()">
                        <option value="">All Tickers</option>
                        <option value="SPY">SPY</option>
                        <option value="AAPL">AAPL</option>
                        <option value="TSLA">TSLA</option>
                        <option value="META">META</option>
                        <option value="NVDA">NVDA</option>
                        <option value="AMZN">AMZN</option>
                    </select>
                    <select id="filterStatus" onchange="filterTrades()">
                        <option value="">All Status</option>
                        <option value="Open">Open</option>
                        <option value="Closed">Closed</option>
                    </select>
                    <select id="filterStrategy" onchange="filterTrades()">
                        <option value="">All Strategies</option>
                        <option value="Supplier News">Supplier News</option>
                        <option value="Market Bellwether">Market Bellwether</option>
                        <option value="Orderly Pullbacks">Orderly Pullbacks</option>
                        <option value="Options Volume">Options Volume</option>
                        <option value="Trend Following">Trend Following</option>
                    </select>
                </div>
                <div class="trades-actions">
                    <button class="btn btn-secondary btn-sm" onclick="exportTrades()">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="clearAllTrades()">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
            </div>
            <div id="tradesListContainer"></div>
        </div>

        <!-- Analytics Tab -->
        <div class="tab-panel" id="tab-analytics">
            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-chart-bar"></i> P&amp;L by Ticker</h3>
                    <div style="position:relative;height:260px;">
                        <canvas id="pnlByTickerChart"></canvas>
                        <div id="pnlByTickerEmpty" class="chart-empty-state" style="display:none;">
                            <i class="fas fa-chart-bar" style="font-size:2.5rem;color:rgba(201,176,55,0.25);margin-bottom:0.75rem;"></i>
                            <p>No closed trades yet</p>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-chart-pie"></i> Win Rate</h3>
                    <div style="position:relative;height:260px;">
                        <canvas id="winRateChart"></canvas>
                        <div id="winRateEmpty" class="chart-empty-state" style="display:none;">
                            <i class="fas fa-chart-pie" style="font-size:2.5rem;color:rgba(201,176,55,0.25);margin-bottom:0.75rem;"></i>
                            <p>No closed trades yet</p>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-calendar-alt"></i> Monthly Performance</h3>
                    <div style="position:relative;height:260px;">
                        <canvas id="monthlyPnLChart"></canvas>
                        <div id="monthlyPnLEmpty" class="chart-empty-state" style="display:none;">
                            <i class="fas fa-calendar-alt" style="font-size:2.5rem;color:rgba(201,176,55,0.25);margin-bottom:0.75rem;"></i>
                            <p>No closed trades yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Add / Edit Trade Modal -->
    <div class="modal" id="tradeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-plus-circle"></i> <span id="modalTitle">Add New Trade</span></h2>
                <button class="close-modal" onclick="closeTradeModal()"><i class="fas fa-times"></i></button>
            </div>
            <form id="tradeForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="tradeType">Trade Type</label>
                        <select id="tradeType" required onchange="toggleTradeTypeFields()">
                            <option value="Stock">Stock</option>
                            <option value="Option">Option</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tradeDate">Date &amp; Time</label>
                        <input type="datetime-local" id="tradeDate" required>
                    </div>
                    <div class="form-group">
                        <label for="ticker">Ticker</label>
                        <select id="ticker" required>
                            <option value="">Select Ticker</option>
                            <option value="SPY">SPY</option>
                            <option value="AAPL">AAPL</option>
                            <option value="TSLA">TSLA</option>
                            <option value="META">META</option>
                            <option value="NVDA">NVDA</option>
                            <option value="AMZN">AMZN</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="direction">Direction</label>
                        <select id="direction" required>
                            <option value="">Select Direction</option>
                            <option value="Long">Long</option>
                            <option value="Short">Short</option>
                        </select>
                    </div>
                    <!-- Options-specific fields -->
                    <div class="form-group option-field" style="display:none;">
                        <label for="optionType">Option Type</label>
                        <select id="optionType">
                            <option value="">Select Type</option>
                            <option value="Call">Call</option>
                            <option value="Put">Put</option>
                        </select>
                    </div>
                    <div class="form-group option-field" style="display:none;">
                        <label for="strikePrice">Strike Price ($)</label>
                        <input type="number" id="strikePrice" step="0.50" min="0">
                    </div>
                    <div class="form-group option-field" style="display:none;">
                        <label for="expirationDate">Expiration Date</label>
                        <input type="date" id="expirationDate">
                    </div>
                    <div class="form-group option-field" style="display:none;">
                        <label for="contracts">Contracts</label>
                        <input type="number" id="contracts" step="1" min="1">
                    </div>
                    <!-- Stock-specific fields -->
                    <div class="form-group stock-field">
                        <label for="shares">Shares / Position Size</label>
                        <input type="number" id="shares" step="1" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="strategy">Strategy Used</label>
                        <select id="strategy" required>
                            <option value="">Select Strategy</option>
                            <option value="Supplier News">Supplier News</option>
                            <option value="Market Bellwether">Market Bellwether</option>
                            <option value="Orderly Pullbacks">Orderly Pullbacks</option>
                            <option value="Options Volume">Options Volume</option>
                            <option value="Delivery & Production">Delivery &amp; Production</option>
                            <option value="Embrace Volatility">Embrace Volatility</option>
                            <option value="Supply & Demand">Supply &amp; Demand</option>
                            <option value="Trend Following">Trend Following</option>
                            <option value="Economic Data">Economic Data</option>
                            <option value="Support & Resistance">Support &amp; Resistance</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="entryPrice" id="entryPriceLabel">Entry Price ($)</label>
                        <input type="number" id="entryPrice" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="exitPrice" id="exitPriceLabel">Exit Price ($)</label>
                        <input type="number" id="exitPrice" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status" required>
                            <option value="Open">Open</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="entryReason">Entry Reason</label>
                        <textarea id="entryReason" placeholder="Why did you enter this trade?"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="exitReason">Exit Reason</label>
                        <textarea id="exitReason" placeholder="Why did you exit this trade?"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="notes">Additional Notes</label>
                        <textarea id="notes" placeholder="Any additional observations or lessons learned"></textarea>
                    </div>
                </div>
                <div style="display:flex;gap:0.75rem;align-items:center;">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> <span id="submitBtnText">Save Trade</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer-placeholder" data-footer-type="standard-social" data-base=""></div>
    <script src="assets/js/footer-component.js"></script>

    <script type="module">
        import { auth, db, onAuthStateChanged, doc, getDoc, setDoc, updateDoc } from './assets/js/firebase-config.js';

        // Trading Journal Application
        let trades = [];
        let editingTradeId = null;
        let charts = {};
        let currentUserId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('tradeDate').value = now.toISOString().slice(0, 16);
            renderTradesList();
            updateStats();
            renderCharts();
            prefillFromPlanner();
        });

        // Pre-fill trade form from Trade Planner "Push to Journal" flow
        function prefillFromPlanner() {
            const raw = localStorage.getItem('bcs_pending_journal_trade');
            if (!raw) return;
            try {
                const pending = JSON.parse(raw);
                localStorage.removeItem('bcs_pending_journal_trade');

                // Set trade type and direction
                document.getElementById('tradeType').value = pending.tradeType || 'Stock';
                toggleTradeTypeFields();
                document.getElementById('ticker').value     = pending.ticker    || '';
                document.getElementById('direction').value  = pending.direction  || '';

                if (pending.tradeType === 'Option' && pending.optionType) {
                    document.getElementById('optionType').value = pending.optionType;
                }

                if (pending.entryPrice) {
                    document.getElementById('entryPrice').value = pending.entryPrice;
                }

                if (pending.notes) {
                    document.getElementById('entryReason').value = pending.notes;
                }

                document.getElementById('modalTitle').textContent = 'New Trade (from Planner)';
                openTradeModal();

                // Switch to the Trades tab so it's visible when the modal closes
                const tradesTabBtn = document.querySelector('.tab-btn:nth-child(2)');
                if (tradesTabBtn) switchTab('trades', tradesTabBtn);
            } catch (err) {
                console.error('Error prefilling from planner:', err);
            }
        }

        // Toggle trade type fields
        window.toggleTradeTypeFields = function() {
            const tradeType = document.getElementById('tradeType').value;
            const optionFields = document.querySelectorAll('.option-field');
            const stockFields = document.querySelectorAll('.stock-field');

            if (tradeType === 'Option') {
                optionFields.forEach(field => {
                    field.style.display = 'flex';
                    const input = field.querySelector('input, select');
                    if (input) input.required = true;
                });
                stockFields.forEach(field => {
                    field.style.display = 'none';
                    const input = field.querySelector('input, select');
                    if (input) input.required = false;
                });
                document.getElementById('entryPriceLabel').textContent = 'Entry Premium ($)';
                document.getElementById('exitPriceLabel').textContent = 'Exit Premium ($)';
            } else {
                optionFields.forEach(field => {
                    field.style.display = 'none';
                    const input = field.querySelector('input, select');
                    if (input) input.required = false;
                });
                stockFields.forEach(field => {
                    field.style.display = 'flex';
                    const input = field.querySelector('input, select');
                    if (input) input.required = true;
                });
                document.getElementById('entryPriceLabel').textContent = 'Entry Price ($)';
                document.getElementById('exitPriceLabel').textContent = 'Exit Price ($)';
            }
        };

        // Form Submit
        document.getElementById('tradeForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const tradeType = document.getElementById('tradeType').value;

            const trade = {
                id: editingTradeId || Date.now().toString(),
                tradeType: tradeType,
                date: document.getElementById('tradeDate').value,
                ticker: document.getElementById('ticker').value,
                direction: document.getElementById('direction').value,
                strategy: document.getElementById('strategy').value,
                entryPrice: parseFloat(document.getElementById('entryPrice').value),
                exitPrice: document.getElementById('exitPrice').value ? parseFloat(document.getElementById('exitPrice').value) : null,
                status: document.getElementById('status').value,
                entryReason: document.getElementById('entryReason').value,
                exitReason: document.getElementById('exitReason').value,
                notes: document.getElementById('notes').value
            };

            if (tradeType === 'Option') {
                trade.optionType = document.getElementById('optionType').value;
                trade.strikePrice = parseFloat(document.getElementById('strikePrice').value);
                trade.expirationDate = document.getElementById('expirationDate').value;
                trade.contracts = parseFloat(document.getElementById('contracts').value);
            } else {
                trade.shares = parseFloat(document.getElementById('shares').value);
            }

            // Calculate P&L
            if (trade.exitPrice) {
                if (tradeType === 'Option') {
                    trade.pnl = (trade.exitPrice - trade.entryPrice) * trade.contracts * 100;
                } else {
                    if (trade.direction === 'Long') {
                        trade.pnl = (trade.exitPrice - trade.entryPrice) * trade.shares;
                    } else {
                        trade.pnl = (trade.entryPrice - trade.exitPrice) * trade.shares;
                    }
                }
            } else {
                trade.pnl = 0;
            }

            if (editingTradeId) {
                const index = trades.findIndex(t => t.id === editingTradeId);
                trades[index] = trade;
                editingTradeId = null;
            } else {
                trades.unshift(trade);
            }

            saveTrades();
            resetForm();
            closeTradeModal();
            renderTradesList();
            updateStats();
            renderCharts();
        });

        // Save trades to Firestore
        async function saveTrades() {
            if (!currentUserId) {
                console.error('No user logged in');
                return;
            }
            try {
                const userTradesRef = doc(db, 'users', currentUserId);
                await updateDoc(userTradesRef, {
                    trades: trades,
                    lastUpdated: new Date().toISOString()
                });
            } catch (error) {
                console.error('Error saving trades:', error);
                localStorage.setItem('bluechip_trades', JSON.stringify(trades));
            }
        }

        // Load trades from Firestore
        async function loadTrades() {
            if (!currentUserId) return;
            try {
                const userTradesRef = doc(db, 'users', currentUserId);
                const userDoc = await getDoc(userTradesRef);

                if (userDoc.exists() && userDoc.data().trades) {
                    trades = userDoc.data().trades;
                } else {
                    trades = [];
                    const localTrades = JSON.parse(localStorage.getItem('bluechip_trades') || '[]');
                    if (localTrades.length > 0) {
                        trades = localTrades;
                        await saveTrades();
                        localStorage.removeItem('bluechip_trades');
                    }
                }

                renderTradesList();
                updateStats();
                renderCharts();
            } catch (error) {
                console.error('Error loading trades:', error);
                trades = JSON.parse(localStorage.getItem('bluechip_trades') || '[]');
                renderTradesList();
                updateStats();
                renderCharts();
            }
        }

        // Reset form
        function resetForm() {
            document.getElementById('tradeForm').reset();
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('tradeDate').value = now.toISOString().slice(0, 16);
            document.getElementById('tradeType').value = 'Stock';
            toggleTradeTypeFields();
            editingTradeId = null;
            document.getElementById('submitBtnText').textContent = 'Save Trade';
            document.getElementById('modalTitle').textContent = 'Add New Trade';
        }

        // Edit trade
        window.editTrade = function(id) {
            const trade = trades.find(t => t.id === id);
            if (!trade) return;

            document.getElementById('tradeType').value = trade.tradeType || 'Stock';
            toggleTradeTypeFields();
            document.getElementById('tradeDate').value = trade.date;
            document.getElementById('ticker').value = trade.ticker;
            document.getElementById('direction').value = trade.direction;
            document.getElementById('strategy').value = trade.strategy;
            document.getElementById('entryPrice').value = trade.entryPrice;
            document.getElementById('exitPrice').value = trade.exitPrice || '';
            document.getElementById('status').value = trade.status;
            document.getElementById('entryReason').value = trade.entryReason || '';
            document.getElementById('exitReason').value = trade.exitReason || '';
            document.getElementById('notes').value = trade.notes || '';

            if (trade.tradeType === 'Option') {
                document.getElementById('optionType').value = trade.optionType || '';
                document.getElementById('strikePrice').value = trade.strikePrice || '';
                document.getElementById('expirationDate').value = trade.expirationDate || '';
                document.getElementById('contracts').value = trade.contracts || '';
            } else {
                document.getElementById('shares').value = trade.shares || '';
            }

            editingTradeId = id;
            document.getElementById('submitBtnText').textContent = 'Update Trade';
            document.getElementById('modalTitle').textContent = 'Edit Trade';
            openTradeModal();
        };

        // Delete trade
        window.deleteTrade = async function(id) {
            if (confirm('Are you sure you want to delete this trade?')) {
                trades = trades.filter(t => t.id !== id);
                await saveTrades();
                renderTradesList();
                updateStats();
                renderCharts();
            }
        };

        // Clear all trades
        window.clearAllTrades = async function() {
            if (confirm('Are you sure you want to delete ALL trades? This cannot be undone!')) {
                trades = [];
                await saveTrades();
                renderTradesList();
                updateStats();
                renderCharts();
            }
        };

        // Filter trades
        window.filterTrades = function() {
            const tradeType = document.getElementById('filterTradeType').value;
            const ticker = document.getElementById('filterTicker').value;
            const status = document.getElementById('filterStatus').value;
            const strategy = document.getElementById('filterStrategy').value;

            let filtered = [...trades];
            if (tradeType) filtered = filtered.filter(t => (t.tradeType || 'Stock') === tradeType);
            if (ticker) filtered = filtered.filter(t => t.ticker === ticker);
            if (status) filtered = filtered.filter(t => t.status === status);
            if (strategy) filtered = filtered.filter(t => t.strategy === strategy);

            renderTradesList(filtered);
        };

        // Ticker color map
        const TICKER_COLORS = {
            SPY: 'spy', TSLA: 'tsla', META: 'meta',
            AAPL: 'aapl', NVDA: 'nvda', AMZN: 'amzn'
        };

        // Render trades as compact rows
        function renderTradesList(tradesToRender = trades) {
            const container = document.getElementById('tradesListContainer');

            if (tradesToRender.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No trades yet. Click <strong>Add Trade</strong> to get started!</p>
                    </div>
                `;
                return;
            }

            const rows = tradesToRender.map(trade => {
                const colorClass = TICKER_COLORS[trade.ticker] || 'other';
                const isOption = trade.tradeType === 'Option';
                const pnlSign = trade.pnl > 0 ? '+' : '';
                const pnlClass = trade.pnl > 0 ? 'positive' : trade.pnl < 0 ? 'negative' : 'neutral';
                const dateStr = new Date(trade.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const details = isOption
                    ? `${trade.optionType || ''} $${trade.strikePrice || ''} | ${trade.contracts || ''}C`
                    : `${trade.shares || ''} shares`;
                const entryLabel = `$${(trade.entryPrice || 0).toFixed(2)}`;
                const exitLabel = trade.exitPrice ? `$${trade.exitPrice.toFixed(2)}` : 'â€”';
                const notesHTML = (trade.entryReason || trade.exitReason || trade.notes)
                    ? `<div class="trade-detail-notes">${[trade.entryReason && `<strong>Entry:</strong> ${trade.entryReason}`, trade.exitReason && `<strong>Exit:</strong> ${trade.exitReason}`, trade.notes && `<strong>Notes:</strong> ${trade.notes}`].filter(Boolean).join('<br>')}</div>`
                    : '';

                return `
                <div class="trade-row" id="trade-${trade.id}">
                    <div class="trade-row-main" onclick="toggleTradeRow('${trade.id}')">
                        <div class="trade-ticker-icon ${colorClass}">${trade.ticker}</div>
                        <div class="trade-info">
                            <div class="trade-ticker-name">${trade.ticker}</div>
                            <div class="trade-date">${dateStr}</div>
                        </div>
                        <span class="trade-badge ${trade.direction.toLowerCase()}">${trade.direction}</span>
                        <span class="trade-badge ${isOption ? 'option' : 'stock'}">${trade.tradeType || 'Stock'}</span>
                        <div class="trade-pnl">
                            <div class="trade-pnl-amount ${pnlClass}">${pnlSign}$${Math.abs(trade.pnl).toFixed(2)}</div>
                        </div>
                        <span class="trade-status-badge ${trade.status.toLowerCase()}">${trade.status}</span>
                        <i class="fas fa-chevron-down trade-chevron"></i>
                    </div>
                    <div class="trade-row-detail">
                        <div class="trade-detail-grid">
                            <div>
                                <div class="trade-detail-label">Entry</div>
                                <div class="trade-detail-value">${entryLabel}</div>
                            </div>
                            <div>
                                <div class="trade-detail-label">Exit</div>
                                <div class="trade-detail-value">${exitLabel}</div>
                            </div>
                            <div>
                                <div class="trade-detail-label">Size</div>
                                <div class="trade-detail-value">${details}</div>
                            </div>
                            <div>
                                <div class="trade-detail-label">Strategy</div>
                                <div class="trade-detail-value">${trade.strategy || 'â€”'}</div>
                            </div>
                        </div>
                        ${notesHTML}
                        <div class="trade-detail-actions">
                            <button class="btn btn-secondary btn-sm" onclick="editTrade('${trade.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTrade('${trade.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');

            container.innerHTML = rows;
        }

        // Toggle trade row expand/collapse
        window.toggleTradeRow = function(id) {
            const row = document.getElementById('trade-' + id);
            if (row) row.classList.toggle('expanded');
        };

        // Update stats
        function updateStats() {
            const closedTrades = trades.filter(t => t.status === 'Closed' && t.exitPrice);
            const totalPnL = closedTrades.reduce((sum, t) => sum + t.pnl, 0);
            const winningTrades = closedTrades.filter(t => t.pnl > 0);
            const winRate = closedTrades.length > 0 ? (winningTrades.length / closedTrades.length * 100) : 0;
            const bestTrade = closedTrades.length > 0 ? Math.max(...closedTrades.map(t => t.pnl)) : 0;
            const openTrades = trades.filter(t => t.status === 'Open').length;

            const formattedPnL = (totalPnL >= 0 ? '+' : '') + '$' + totalPnL.toFixed(2);
            const formattedBest = (bestTrade >= 0 ? '+' : '') + '$' + bestTrade.toFixed(2);

            // Hero P&L
            const heroPnLEl = document.getElementById('heroPnL');
            if (heroPnLEl) {
                heroPnLEl.textContent = formattedPnL;
                heroPnLEl.className = 'hero-pnl-number' + (totalPnL > 0 ? ' positive' : totalPnL < 0 ? ' negative' : '');
            }

            // Stats row
            const totalTradesEl = document.getElementById('totalTrades');
            if (totalTradesEl) totalTradesEl.textContent = trades.length;
            const winRateEl = document.getElementById('winRate');
            if (winRateEl) winRateEl.textContent = winRate.toFixed(1) + '%';
            const bestTradeEl = document.getElementById('bestTrade');
            if (bestTradeEl) bestTradeEl.textContent = formattedBest;
            const openPositionsEl = document.getElementById('openPositions');
            if (openPositionsEl) openPositionsEl.textContent = openTrades;

            // Overview insight cards
            const insightTotal = document.getElementById('insightTotalPnL');
            if (insightTotal) insightTotal.textContent = formattedPnL;
            const insightWin = document.getElementById('insightWinRate');
            if (insightWin) insightWin.textContent = winRate.toFixed(1) + '%';
            const winProgress = document.getElementById('winRateProgress');
            if (winProgress) winProgress.style.width = Math.min(Math.max(winRate, 0), 100) + '%';
            const openInsight = document.getElementById('openTradesInsight');
            if (openInsight) openInsight.textContent = openTrades;
        }

        // Render charts
        function renderCharts() {
            renderEquityCurve();
            renderPnLByTicker();
            renderWinRate();
            renderMonthlyPnL();
        }

        // Equity Curve
        function renderEquityCurve() {
            const ctx = document.getElementById('equityCurveChart');
            const emptyState = document.getElementById('equityCurveEmpty');
            if (charts.equityCurve) charts.equityCurve.destroy();

            const closedTrades = trades.filter(t => t.status === 'Closed' && t.exitPrice)
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            if (closedTrades.length === 0) {
                ctx.style.display = 'none';
                emptyState.style.display = 'flex';
                return;
            }

            ctx.style.display = 'block';
            emptyState.style.display = 'none';

            let cumulative = 0;
            const data = closedTrades.map(trade => {
                cumulative += trade.pnl;
                return { x: new Date(trade.date), y: cumulative };
            });

            charts.equityCurve = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Cumulative P&L',
                        data: data,
                        borderColor: '#b3a17d',
                        backgroundColor: 'rgba(179, 161, 125, 0.15)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day' },
                            grid: { color: 'rgba(201, 176, 55, 0.1)' },
                            ticks: { color: '#A0A0A0' }
                        },
                        y: {
                            grid: { color: 'rgba(201, 176, 55, 0.1)' },
                            ticks: { color: '#A0A0A0', callback: value => '$' + value.toFixed(0) }
                        }
                    }
                }
            });
        }

        // P&L by Ticker
        function renderPnLByTicker() {
            const ctx = document.getElementById('pnlByTickerChart');
            const emptyState = document.getElementById('pnlByTickerEmpty');
            if (charts.pnlByTicker) charts.pnlByTicker.destroy();

            const closedTrades = trades.filter(t => t.status === 'Closed' && t.exitPrice);
            if (closedTrades.length === 0) {
                ctx.style.display = 'none';
                emptyState.style.display = 'flex';
                return;
            }

            ctx.style.display = 'block';
            emptyState.style.display = 'none';

            const pnlByTicker = {};
            closedTrades.forEach(trade => {
                if (!pnlByTicker[trade.ticker]) pnlByTicker[trade.ticker] = 0;
                pnlByTicker[trade.ticker] += trade.pnl;
            });

            const labels = Object.keys(pnlByTicker);
            const data = Object.values(pnlByTicker);
            const colors = data.map(val => val >= 0 ? '#10b981' : '#ef4444');

            charts.pnlByTicker = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'P&L', data: data, backgroundColor: colors }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(201, 176, 55, 0.1)' }, ticks: { color: '#A0A0A0' } },
                        y: { grid: { color: 'rgba(201, 176, 55, 0.1)' }, ticks: { color: '#A0A0A0', callback: value => '$' + value.toFixed(0) } }
                    }
                }
            });
        }

        // Win Rate
        function renderWinRate() {
            const ctx = document.getElementById('winRateChart');
            const emptyState = document.getElementById('winRateEmpty');
            if (charts.winRate) charts.winRate.destroy();

            const closedTrades = trades.filter(t => t.status === 'Closed' && t.exitPrice);
            if (closedTrades.length === 0) {
                ctx.style.display = 'none';
                emptyState.style.display = 'flex';
                return;
            }

            ctx.style.display = 'block';
            emptyState.style.display = 'none';

            const wins = closedTrades.filter(t => t.pnl > 0).length;
            const losses = closedTrades.filter(t => t.pnl < 0).length;
            const breakeven = closedTrades.filter(t => t.pnl === 0).length;

            charts.winRate = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Wins', 'Losses', 'Breakeven'],
                    datasets: [{
                        data: [wins, losses, breakeven],
                        backgroundColor: ['#4ade80', '#ef4444', '#6b7280'],
                        borderColor: ['#22c55e', '#dc2626', '#4b5563'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#A0A0A0',
                                font: { family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif' }
                            }
                        }
                    }
                }
            });
        }

        // Monthly P&L
        function renderMonthlyPnL() {
            const ctx = document.getElementById('monthlyPnLChart');
            const emptyState = document.getElementById('monthlyPnLEmpty');
            if (charts.monthlyPnL) charts.monthlyPnL.destroy();

            const closedTrades = trades.filter(t => t.status === 'Closed' && t.exitPrice);
            if (closedTrades.length === 0) {
                ctx.style.display = 'none';
                emptyState.style.display = 'flex';
                return;
            }

            ctx.style.display = 'block';
            emptyState.style.display = 'none';

            const monthlyData = {};
            closedTrades.forEach(trade => {
                const month = new Date(trade.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                if (!monthlyData[month]) monthlyData[month] = 0;
                monthlyData[month] += trade.pnl;
            });

            const labels = Object.keys(monthlyData);
            const data = Object.values(monthlyData);
            const colors = data.map(val => val >= 0 ? '#10b981' : '#ef4444');

            charts.monthlyPnL = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Monthly P&L', data: data, backgroundColor: colors }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(201, 176, 55, 0.1)' }, ticks: { color: '#A0A0A0' } },
                        y: { grid: { color: 'rgba(201, 176, 55, 0.1)' }, ticks: { color: '#A0A0A0', callback: value => '$' + value.toFixed(0) } }
                    }
                }
            });
        }

        // Export to CSV
        window.exportTrades = function() {
            if (trades.length === 0) {
                alert('No trades to export!');
                return;
            }
            const headers = ['Date', 'Trade Type', 'Ticker', 'Direction', 'Strategy', 'Option Type', 'Strike Price', 'Expiration', 'Contracts', 'Shares', 'Entry Price', 'Exit Price', 'P&L', 'Status', 'Entry Reason', 'Exit Reason', 'Notes'];
            const rows = trades.map(t => [
                t.date, t.tradeType || 'Stock', t.ticker, t.direction, t.strategy,
                t.optionType || '', t.strikePrice || '', t.expirationDate || '', t.contracts || '',
                t.shares || '', t.entryPrice, t.exitPrice || '', t.pnl, t.status,
                t.entryReason || '', t.exitReason || '', t.notes || ''
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => { csv += row.map(val => `"${val}"`).join(',') + '\n'; });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bluechip-trades-${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        };

        // Modal controls
        window.openTradeModal = function() {
            document.getElementById('tradeModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        };

        window.closeTradeModal = function() {
            document.getElementById('tradeModal').classList.remove('active');
            document.body.style.overflow = '';
        };

        // Close modal on backdrop click
        document.getElementById('tradeModal').addEventListener('click', function(e) {
            if (e.target === this) closeTradeModal();
        });

        // Tab switching
        window.switchTab = function(tabName, btnEl) {
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            if (btnEl) btnEl.classList.add('active');
        };

        // Logout
        window.logout = async function() {
            try {
                await auth.signOut();
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        };

        // Auth check
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                currentUserId = user.uid;
                await loadTrades();
                updateAuthButton();
            }
        });

        function updateAuthButton() {
            const authButton = document.getElementById('authButton');
            if (authButton && authButton.parentElement) {
                const logoutBtn = document.createElement('button');
                logoutBtn.className = 'logout-btn';
                logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Logout';
                logoutBtn.onclick = window.logout;
                authButton.parentElement.replaceChild(logoutBtn, authButton);
            }
        }
    </script>
</body>
</html>
